# معماری پروژه

این سند یک نمای کلی از ساختار فنی و معماری شیرازه ارائه می‌دهد. این اطلاعات برای توسعه‌دهندگانی که قصد مشارکت در پروژه را دارند یا کاربرانی که علاقه‌مند به درک نحوه کارکرد آن هستند، مفید است.

## اصول طراحی

شیرازه بر پایه چند اصل کلیدی طراحی شده است:

-   **بدون فرآیند ساخت (Zero-Build):** تمام کدها (جاوااسکریپت، CSS و HTML) به صورت خالص و بدون نیاز به کامپایلر یا باندلر نوشته شده‌اند.
-   **سمت کاربر (Client-Side):** تمام منطق برنامه، از مسیریابی گرفته تا رندر کردن مارک‌داون، در مرورگر کاربر اجرا می‌شود.
-   **ماژولار بودن:** کدها به ماژول‌های کوچک و مستقل تقسیم شده‌اند که هر کدام یک وظیفه مشخص دارند (اصل Single Responsibility).
-   **تنظیمات محور (Configuration-Driven):** رفتار اصلی برنامه از طریق یک فایل پیکربندی مرکزی کنترل می‌شود.

## پشته فناوری (Technology Stack)

شیرازه با تمرکز بر سادگی و کارایی، از یک پشته فناوری سبک و مدرن استفاده می‌کند:

-   **زبان‌های اصلی:** HTML5، CSS3 و جاوااسکریپت خالص (ES6+ Modules).
-   **بدون فریم‌ورک:** پروژه کاملاً با جاوااسکریپت خالص (Vanilla JS) نوشته شده است تا حداکثر سرعت، حداقل وابستگی و شفافیت کامل را فراهم کند.
-   **مفسر مارک‌داون:** کتابخانه قدرتمند `markdown-it` به عنوان هسته مفسر پیش‌فرض (پارس‌نشان) استفاده می‌شود که با افزونه‌های سفارشی برای زبان فارسی غنی شده است.
-   **بدون ابزار ساخت:** هیچ نیازی به ابزارهای پیچیده‌ای مانند Webpack, Rollup یا Vite نیست. کدها به صورت مستقیم و بدون هیچ فرآیندی در مرورگر اجرا می‌شوند.
-   **هاستینگ:** به دلیل ماهیت کاملاً استاتیک، شیرازه روی هر سرویس میزبانی فایل استاتیک (مانند GitHub Pages, Netlify, Vercel) یا حتی یک سرور ساده قابل اجراست.

## ساختار پوشه‌ها

```
shirazeh/
├── config/              # تمام فایل‌های پیکربندی کاربر
│   ├── parsers/         # پوشه جدید برای مفسرهای سفارشی
│   ├── config.js
│   └── sidebar.md
├── docs/                # مستندات پروژه
├── src/                 # کدهای اصلی و هسته برنامه
│   ├── core/            # ماژول‌های اصلی (مغز برنامه)
│   │   ├── app.js
│   │   ├── configManager.js
│   │   ├── domRenderer.js
│   │   ├── fileReader.js
│   │   ├── parserManager.js
│   │   ├── pluginManager.js
│   │   ├── router.js
│   │   ├── sidebar.js
│   │   ├── themeManager.js
│   │   ├── titleManager.js  # ماژول جدید مدیریت عنوان
│   │   └── utils.js         # ماژول جدید ابزارهای کمکی
│   ├── parsers/         # پوشه جدید برای مفسرهای داخلی
│   │   └── marked.js
│   ├── styles/          # فایل‌های CSS
│   └── index.js         # نقطه ورود اصلی برنامه
├── *.md                 # فایل‌های نمونه محتوا
└── index.html           # فایل ورودی HTML
```

## نقش ماژول‌های اصلی (`src/core/`)

-   **`index.js`:** نقطه شروع برنامه. وظیفه آن بارگذاری تنظیمات و مقداردهی اولیه کلاس `App` است.
-   **`app.js`:** ارکستراتور اصلی برنامه. این ماژول ساختار HTML را ایجاد کرده، تمام ماژول‌ها را هماهنگ، چرخه حیات برنامه را مدیریت کرده و مسئولیت بازنویسی لینک‌های داخلی محتوای خارجی را بر عهده دارد. **مدیریت عنوان تب مرورگر را به `titleManager` واگذار می‌کند.**
-   **`configManager.js`:** مسئول بارگذاری تنظیمات پیش‌فرض و ادغام آن‌ها با تنظیمات کاربر (`config.js`).
-   **`parserManager.js`:** مسئولیت بارگذاری، نمونه‌سازی و مدیریت مفسر مارک‌داون را بر عهده دارد.
-   **`pluginManager.js`:** چرخه حیات افزونه‌ها را مدیریت می‌کند (بارگذاری، اجرای هوک‌ها و...).
-   **`router.js`:** مسیریاب سمت کاربر که تغییرات URL hash را مدیریت می‌کند. این ماژول قادر است مسیرهای مربوط به فایل‌های خارجی (که با `/remote/` شروع می‌شوند) را شناسایی و رمزگشایی کند.
-   **`sidebar.js`:** مسئولیت کامل منوی کناری را بر عهده دارد. این ماژول لینک‌های خارجی را بر اساس فعال بودن قابلیت `remote` به مسیرهای داخلی تبدیل کرده یا به عنوان لینک خارجی استاندارد در نظر می‌گیرد.
-   **`themeManager.js`:** تمام منطق مربوط به تم (روشن/تاریک) و فونت‌ها را مدیریت می‌کند.
-   **`titleManager.js`:** این ماژول جدید، مسئولیت کامل مدیریت عنوان تب مرورگر را بر عهده دارد. این ماژول بر اساس تنظیمات کاربر و محتوای صفحه فعلی، بهترین عنوان را انتخاب و اعمال می‌کند.
-   **`fileReader.js`:** یک ماژول ساده برای واکشی (fetch) محتوای فایل‌ها. این ماژول در صورت نیاز از پروکسی CORS برای واکشی URLهای خارجی استفاده می‌کند.
-   **`domRenderer.js`:** تنها ماژولی که مستقیماً با DOM در ارتباط است و وظیفه رندر محتوا، خطا و پیام بارگذاری را دارد.
-   **`utils.js`:** یک ماژول کمکی شامل توابع مشترک مانند رمزگذاری و رمزگشایی امن (UTF-8 safe) Base64 و نرمال‌سازی مسیرها که در سراسر برنامه استفاده می‌شوند.

## جریان اجرای برنامه

یک نمودار متنی ساده از نحوه اجرای برنامه:

```
[کاربر صفحه را باز می‌کند]
       |
       v
1. index.html بارگذاری می‌شود
       |
       v
2. index.js اجرا می‌شود
       |
       v
3. configManager.js تنظیمات را ادغام می‌کند
       |
       v
4. app.js با تنظیمات نهایی مقداردهی اولیه می‌شود
       |
       v
5. app.js ماژول `parserManager` را برای بارگذاری مفسر مارک‌داون (داخلی یا سفارشی) فراخوانی می‌کند.
       |
       v
6. app.js ساختار اصلی HTML را در DOM ایجاد می‌کند
       |
       v
7. themeManager.js تم (روشن/تاریک) و فونت‌ها را بر اساس اولویت اعمال می‌کند.
       |
       v
8. app.js ماژول‌های Sidebar و Router را مقداردهی اولیه می‌کند
       |
       v
9. Sidebar محتوای منو را از sidebar.md بارگذاری و رندر می‌کند
       |
       v
10. Router مسیر فعلی را از URL می‌خواند
       |
       v
11. Router به App می‌گوید که صفحه مربوطه را بارگذاری کند
       |
       v
12. App از fileReader برای خواندن فایل مارک‌داون استفاده می‌کند
       |
       v
13. App (در صورت نیاز) لینک‌های داخلی محتوای خارجی را بازنویسی می‌کند
       |
       v
14. App محتوای خوانده شده را به `parserManager` می‌دهد تا به HTML تبدیل شود
       |
       v
15. App از domRenderer برای نمایش HTML نهایی در صفحه استفاده می‌کند
       |
       v
16. App به `titleManager` اطلاع می‌دهد تا عنوان تب مرورگر را به‌روزرسانی کند
```

این جریان برای هر بار تغییر مسیر (کلیک روی لینک‌های منو) از مرحله ۱۰ به بعد تکرار می‌شود.